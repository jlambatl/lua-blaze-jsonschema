require("spec.spec_helper")

local luablaze = require("luablaze")

describe("Simple Metrics Schema", function()
    it("returns false and report when relative_start_time is negative (violates minimum: 0 constraint)", function()
        local schema =
        '{"$schema":"https://json-schema.org/draft/2020-12/schema","$id":"telemetry_schema_v0.json","title":"Simple Schema","description":"Schema Simple telemetry data including Span and Gauge metrics","type":"object","oneOf":[{"$ref":"#/$defs/Span"},{"$ref":"#/$defs/Gauge"}],"$defs":{"unixTimestampNano":{"description":"Unix timestamp in nanoseconds (19 digits)","oneOf":[{"description":"Unix timestamp in nanoseconds (19 digits)","type":"integer","minimum":1000000000000000000,"maximum":9999999999999999999},{"description":"Sometimes these need to be strings due to architecture differences in number handling","type":"string","pattern":"^[0-9]{19}$"}]},"cohortItem":{"type":"object","description":"Cohort information with arbitrary key-value pairs","additionalProperties":{"type":"string"}},"commonFields":{"type":"object","properties":{"name":{"description":"Event name","type":"string","minLength":1},"long_name":{"description":"Long form event name","type":"string","minLength":1},"cohort":{"description":"Cohort information","type":"object","$ref":"#/$defs/cohortItem"},"span_id":{"description":"Unique span identifier","type":"string","minLength":1},"parent_span_id":{"description":"Parent span identifier","type":"string","minLength":1},"trace_id":{"description":"Trace identifier","type":"string","minLength":1},"relative_start_time":{"description":"Relative start time","type":"number","minimum":0},"product":{"description":"Product name","type":"string","minLength":1},"subproduct":{"description":"Subproduct name","type":"string","minLength":1},"env":{"description":"Environment (dev, staging, prod, etc.)","type":"string","minLength":1},"experience":{"description":"User experience identifier","type":"string","minLength":1},"page_load_type":{"description":"Type of page load event","type":"string","minLength":1},"hostname":{"description":"Hostname where event occurred","type":"string","minLength":0,"maxLength":254},"resource_attributes":{"description":"Additional resource attributes","type":"object","additionalProperties":true},"origin_event_timestamp":{"description":"Original event timestamp","type":"string","format":"date-time","minLength":1},"tenant_id":{"description":"Tenant identifier","type":"string","minLength":1},"message_id":{"description":"Message identifier for correlation","type":"string","minLength":1},"id":{"description":"Event identifier","type":"string","minLength":1},"start_time_unix_nano":{"description":"Start time in Unix nanoseconds","$ref":"#/$defs/unixTimestampNano"},"ingestion_mapping_version":{"description":"Version of ingestion mapping used","type":"integer","minimum":0}},"required":["name","long_name","cohort","span_id","trace_id","product","env","experience","start_time_unix_nano","relative_start_time","id","origin_event_timestamp","page_load_type"]},"Span":{"title":"Span","description":"A span represents a single operation within a trace","allOf":[{"$ref":"#/$defs/commonFields"},{"type":"object","properties":{"duration":{"description":"Duration of the span","type":"number","minimum":0},"end_time_unix_nano":{"description":"End time in Unix nanoseconds","$ref":"#/$defs/unixTimestampNano"},"render_info":{"description":"Optional render performance metrics","type":"object","additionalProperties":{"type":"number"},"properties":{"rerender_count":{"description":"Number of re-renders","type":"number","minimum":0},"self_render_duration":{"description":"Duration of self render","type":"number","minimum":0},"total_render_duration":{"description":"Total render duration","type":"number","minimum":0},"child_render_duration":{"description":"Duration of child renders","type":"number","minimum":0}}}},"required":["duration","end_time_unix_nano"]}]},"Gauge":{"title":"Gauge","description":"A gauge represents a metric that can go up or down","allOf":[{"$ref":"#/$defs/commonFields"},{"type":"object","properties":{"gauge":{"type":"number","description":"Gauge metric value"},"time_unix_nano":{"$ref":"#/$defs/unixTimestampNano","description":"Measurement time in Unix nanoseconds"}},"required":["gauge","time_unix_nano"]}]}}}'
        local data_to_validate =
        '{"hostname":"","env":"prod","message_id":"test-negative-starttime-scenario2","span_id":"6ffc3b986be96a71","end_time_unix_nano":"1767940085950000128","origin_event_timestamp":"2026-01-09T06:28:06.000+00:00","experience":"jira.fe.page-load.issue-view-software","page_load_type":"initial","product":"jira","ingestion_mapping_version":6,"duration":50,"tenant_id":"test-tenant-123","parent_span_id":"test-span-012","id":"db9af93fefb794b4b744434f70dd5765","name":"fmp","subproduct":"software","start_time_unix_nano":"1767940085900000000","trace_id":"test-trace-789","relative_start_time":-100,"resource_attributes":{"location_subdivision":"","page_load_id":"","location_city":"","version":"","user_id_type":"","tenant_id_type":"","browser_version":"","event_type":"","org_id":"","origin":"","device_family":"","location_continent":"","event_id":"","browser":""},"long_name":"fmp","cohort":{"device_type":""}}'
        local compiled = luablaze.new(schema)
        local ok, report = compiled:validate_json_detailed(data_to_validate)
        assert.is_false(ok)
        assert.is_not_nil(report)
    end)
end)
